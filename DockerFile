# ===== 第一阶段：构建阶段 =====
# 使用官方 Maven 镜像（推荐 JDK 17 以兼容 Spring Boot 3.x）
FROM maven:3.8.6-eclipse-temurin-17 as build

# 设置工作目录
WORKDIR /app

# 1. 复制构建文件（利用分层缓存优化）
COPY pom.xml settings.xml ./
# 2. 先下载依赖（单独一层，避免源码变动重复下载）
RUN mvn -s settings.xml dependency:go-offline

# 3. 复制源码并构建
COPY src ./src
RUN mvn -s settings.xml clean package -DskipTests

# ===== 第二阶段：运行阶段 =====
# 使用轻量级 JRE 镜像（基于 Eclipse Temurin）
FROM eclipse-temurin:17-jre-jammy

# 时区设置（上海时区）
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo "Asia/Shanghai" > /etc/timezone

# 安装 CA 证书（HTTPS 必需）
RUN apt-get update && \
    apt-get install -y ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 从构建阶段复制 JAR 包
COPY --from=build /app/target/*.jar ./app.jar

# 暴露端口（微信云托管要求 80）
EXPOSE 80

# 启动命令（使用 ENTRYPOINT + CMD 最佳实践）
ENTRYPOINT ["java", "-jar"]
CMD ["/app/app.jar"]
